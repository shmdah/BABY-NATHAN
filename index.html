<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#2D1B18">
    
    <title>Nathan's Hub Ultimate</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,600&family=Quicksand:wght@400;600;700&display=swap" rel="stylesheet">
    
    <style>
        :root { --glow-color: #D7CCC8; --water-color: #4fc3f7; }
        body {
            font-family: 'Quicksand', sans-serif;
            background-color: #2D1B18;
            color: #EFEBE9;
            overscroll-behavior: none;
            -webkit-tap-highlight-color: transparent;
        }
        .font-serif { font-family: 'Playfair Display', serif; }

        /* Glassmorphism */
        .glass-card {
            background: rgba(78, 52, 46, 0.4);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 2rem;
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.3);
        }

        /* Nav Drawer Transition */
        #nav-drawer { transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .drawer-open { transform: translateX(0) !important; }
        .drawer-closed { transform: translateX(-100%); }

        /* Animations */
        .glow-icon { filter: drop-shadow(0 0 5px var(--glow-color)); animation: glow-pulse 3s infinite alternate; }
        @keyframes glow-pulse {
            from { filter: drop-shadow(0 0 2px var(--glow-color)); opacity: 0.8; }
            to { filter: drop-shadow(0 0 15px var(--glow-color)); opacity: 1; }
        }

        /* Breathing Animation */
        .breathing-circle {
            animation: breathe 8s infinite ease-in-out;
        }
        @keyframes breathe {
            0%, 100% { transform: scale(1); opacity: 0.5; box-shadow: 0 0 20px #D7CCC8; }
            50% { transform: scale(1.5); opacity: 1; box-shadow: 0 0 60px #D7CCC8; }
        }

        /* Water Wave Animation */
        .water-container {
            position: relative; overflow: hidden; transform: translate3d(0, 0, 0);
        }
        .wave {
            position: absolute; bottom: 0; left: 0; width: 200%; height: 200%;
            background: rgba(79, 195, 247, 0.4);
            border-radius: 40%;
            animation: drift 6s infinite linear;
            transform-origin: 50% 50%;
        }
        .wave:nth-child(2) { animation: drift 8s infinite linear; opacity: 0.3; background: rgba(79, 195, 247, 0.6); }
        .wave:nth-child(3) { animation: drift 10s infinite linear; opacity: 0.2; background: #4fc3f7; }
        @keyframes drift { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

        /* Utilities */
        .safe-pt { padding-top: calc(env(safe-area-inset-top) + 1rem); }
        .safe-pb { padding-bottom: calc(env(safe-area-inset-bottom) + 1.5rem); }
        .back-btn {
            position: fixed; top: 1rem; right: 1rem; z-index: 60;
            padding: 0.75rem; background: rgba(0,0,0,0.3);
            backdrop-filter: blur(10px); border-radius: 50%;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        #confetti-canvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 100; }
        
        textarea::placeholder { color: rgba(161, 136, 127, 0.5); }
    </style>
</head>
<body class="safe-pb">

    <canvas id="confetti-canvas"></canvas>

    <header id="main-header" class="fixed top-0 left-0 right-0 z-50 glass-card rounded-none border-t-0 p-4 flex justify-between items-center safe-pt">
        <button onclick="toggleDrawer()" class="p-2 -ml-2 active:scale-90 transition-transform">
            <i data-lucide="menu" class="w-6 h-6 text-[#EFEBE9]"></i>
        </button>
        
        <div class="text-center">
            <h1 class="font-serif italic text-xl">Nathan's Hub</h1>
            <p id="live-clock" class="text-[10px] tracking-[0.2em] uppercase text-[#A1887F]">Loading...</p>
        </div>

        <div class="flex items-center gap-2">
             <div class="w-2 h-2 rounded-full bg-green-400 animate-pulse"></div>
        </div>
    </header>

    <button id="global-back-btn" onclick="switchView('home')" class="hidden back-btn active:scale-90 transition-transform">
        <i data-lucide="x" class="w-6 h-6 text-[#EFEBE9]"></i>
    </button>

    <div id="nav-drawer" class="fixed inset-y-0 left-0 w-3/4 max-w-xs bg-[#3E2723] z-[60] drawer-closed shadow-2xl p-6 safe-pt border-r border-white/10 flex flex-col justify-between">
        <div>
            <h2 class="font-serif italic text-2xl mb-8 mt-4 text-[#D7CCC8]">Menu</h2>
            <nav class="space-y-4">
                <button onclick="switchView('home'); toggleDrawer()" class="flex items-center gap-4 w-full p-3 rounded-xl hover:bg-white/5">
                    <i data-lucide="home" class="w-5 h-5 text-[#A1887F]"></i>
                    <span>Dashboard</span>
                </button>
                <button onclick="switchView('meds'); toggleDrawer()" class="flex items-center gap-4 w-full p-3 rounded-xl hover:bg-white/5">
                    <i data-lucide="list-checks" class="w-5 h-5 text-[#A1887F]"></i>
                    <span>Routine List</span>
                </button>
                <button onclick="switchView('stats'); toggleDrawer()" class="flex items-center gap-4 w-full p-3 rounded-xl hover:bg-white/5">
                    <i data-lucide="bar-chart-2" class="w-5 h-5 text-[#A1887F]"></i>
                    <span>Weekly Analytics</span>
                </button>
                <button onclick="switchView('timer'); toggleDrawer()" class="flex items-center gap-4 w-full p-3 rounded-xl hover:bg-white/5">
                    <i data-lucide="wind" class="w-5 h-5 text-[#A1887F]"></i>
                    <span>Focus & Breathe</span>
                </button>
                <button onclick="switchView('notes'); toggleDrawer()" class="flex items-center gap-4 w-full p-3 rounded-xl hover:bg-white/5">
                    <i data-lucide="brain-circuit" class="w-5 h-5 text-[#A1887F]"></i>
                    <span>Brain Dump</span>
                </button>
            </nav>
        </div>
        <div class="text-xs text-[#A1887F] text-center pb-8">
            v3.0 ‚Ä¢ Ultimate
        </div>
    </div>
    <div id="drawer-overlay" onclick="toggleDrawer()" class="fixed inset-0 bg-black/50 z-[55] hidden backdrop-blur-sm"></div>

    <main id="home-view" class="min-h-screen pt-24 px-6 pb-32 overflow-y-auto">
        
        <div class="text-center mb-10 relative">
            <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-32 h-32 bg-[#D7CCC8] rounded-full blur-[60px] opacity-10 pointer-events-none"></div>
            
            <span class="block text-[10px] uppercase tracking-[0.3em] text-[#A1887F] mb-2 font-bold animate-pulse">The Daily Protocol</span>
            <h2 class="text-4xl md:text-5xl font-serif italic leading-tight text-[#EFEBE9] drop-shadow-lg">
                A Guide for<br>
                <span class="text-transparent bg-clip-text bg-gradient-to-r from-[#D7CCC8] via-[#EFEBE9] to-[#8D6E63]">Brother Nathan</span>
            </h2>
            <div class="w-16 h-1 bg-gradient-to-r from-transparent via-[#A1887F] to-transparent mx-auto mt-4 opacity-50"></div>
        </div>

        <div class="glass-card p-6 mb-6 text-center relative overflow-hidden group">
            <div class="absolute top-0 left-0 w-1 h-full bg-[#D7CCC8]"></div>
            <p class="text-[10px] uppercase tracking-widest text-[#A1887F] mb-3">Up Next For You</p>
            <div id="next-up-container" class="transition-all duration-500">
                <h3 id="next-task-name" class="text-3xl font-serif italic text-[#EFEBE9] mb-1">Loading...</h3>
                <div class="flex justify-center items-center gap-2 opacity-60">
                    <i data-lucide="clock" class="w-3 h-3"></i>
                    <p id="next-task-time" class="text-xs tracking-widest">--:--</p>
                </div>
            </div>
            <button onclick="quickCompleteNext()" id="quick-check-btn" class="mt-4 px-6 py-2 bg-[#EFEBE9] text-[#3E2723] rounded-full text-xs font-bold uppercase active:scale-95 transition-transform hidden">
                Done
            </button>
        </div>

        <div class="grid grid-cols-2 gap-4 mb-4">
            <button onclick="addWater()" class="glass-card h-40 relative overflow-hidden flex flex-col items-center justify-center group active:scale-95 transition-transform">
                <div class="water-container absolute bottom-0 left-0 w-full transition-all duration-700 ease-in-out" id="water-fill" style="height: 0%">
                    <div class="wave"></div>
                    <div class="wave"></div>
                    <div class="wave"></div>
                </div>
                <div class="relative z-10 flex flex-col items-center text-shadow">
                    <i data-lucide="droplets" class="w-6 h-6 mb-2 text-white drop-shadow-md"></i>
                    <span id="water-count" class="text-2xl font-bold text-white drop-shadow-md">0</span>
                    <span class="text-[10px] uppercase tracking-widest text-white/80 drop-shadow-md">Cups</span>
                </div>
            </button>

            <button onclick="switchView('notes')" class="glass-card p-4 flex flex-col items-center justify-center gap-2 active:scale-95 transition-transform">
                <i data-lucide="pencil" class="w-6 h-6 text-[#A1887F]"></i>
                <span class="text-sm font-serif italic">Brain Dump</span>
            </button>
        </div>

        <div class="grid grid-cols-2 gap-4">
            <button onclick="switchView('meds')" class="glass-card p-4 flex flex-col items-center gap-2 active:scale-95 transition-transform">
                <i data-lucide="list-checks" class="w-6 h-6 text-[#A1887F]"></i>
                <span class="text-sm font-serif italic">Routine</span>
            </button>
            <button onclick="switchView('stats')" class="glass-card p-4 flex flex-col items-center gap-2 active:scale-95 transition-transform">
                <i data-lucide="bar-chart-2" class="w-6 h-6 text-[#A1887F]"></i>
                <span class="text-sm font-serif italic">Stats</span>
            </button>
        </div>
    </main>

    <main id="meds-view" class="hidden min-h-screen pt-24 px-4 pb-40">
        <div class="text-center mb-6">
            <h2 class="text-3xl font-serif italic">Daily Steps</h2>
            <p class="text-[#A1887F] text-xs uppercase tracking-widest mt-1">Today's Progress</p>
        </div>
        <div class="space-y-4" id="meds-list"></div>
    </main>

    <main id="stats-view" class="hidden min-h-screen pt-24 px-4 pb-40 overflow-y-auto">
        <div class="text-center mb-6">
            <h2 class="text-3xl font-serif italic">Weekly Overview</h2>
        </div>

        <div class="glass-card p-4 mb-6">
             <div class="relative h-48 w-full">
                <canvas id="barChart"></canvas>
            </div>
        </div>

        <div class="glass-card p-4 mb-6">
            <h3 class="text-xs uppercase tracking-widest text-[#A1887F] mb-3 text-center">How do you feel today?</h3>
            <div class="flex justify-between px-2" id="mood-selector">
                <button onclick="setMood(1)" class="text-2xl hover:scale-125 transition-transform opacity-50" id="mood-1">üò´</button>
                <button onclick="setMood(2)" class="text-2xl hover:scale-125 transition-transform opacity-50" id="mood-2">üòï</button>
                <button onclick="setMood(3)" class="text-2xl hover:scale-125 transition-transform opacity-50" id="mood-3">üòê</button>
                <button onclick="setMood(4)" class="text-2xl hover:scale-125 transition-transform opacity-50" id="mood-4">üôÇ</button>
                <button onclick="setMood(5)" class="text-2xl hover:scale-125 transition-transform opacity-50" id="mood-5">ü§©</button>
            </div>
        </div>

        <div id="weekly-grid" class="space-y-4"></div>
        
        <div class="text-center mt-8">
            <button onclick="resetWeeklyData()" class="text-[10px] uppercase tracking-widest text-red-300 border border-red-900/50 px-3 py-1 rounded-full hover:bg-red-900/20">
                Reset Week History
            </button>
        </div>
    </main>

    <main id="timer-view" class="hidden min-h-screen flex flex-col items-center justify-center px-6">
        
        <div class="flex bg-[#3E2723] rounded-full p-1 mb-8 border border-white/10">
            <button onclick="setFocusMode('timer')" id="tab-timer" class="px-6 py-2 rounded-full text-xs font-bold uppercase bg-[#EFEBE9] text-[#3E2723] transition-all">Timer</button>
            <button onclick="setFocusMode('breath')" id="tab-breath" class="px-6 py-2 rounded-full text-xs font-bold uppercase text-[#A1887F] transition-all">Breathe</button>
        </div>

        <div id="focus-content-timer" class="w-full max-w-md text-center">
            <div class="glass-card p-8 shadow-2xl border-white/10 relative">
                <div class="absolute top-4 right-4">
                    <button onclick="toggleZenMode()" class="p-2 rounded-full border border-white/10 opacity-60 hover:opacity-100">
                        <i data-lucide="waves" class="w-5 h-5"></i>
                    </button>
                </div>
                <div id="timer-display" class="text-7xl font-light mb-6 tabular-nums tracking-tighter mt-4">05:00</div>
                <div class="flex gap-4 justify-center">
                    <button onclick="toggleTimer()" class="w-20 h-20 bg-[#EFEBE9] text-[#3E2723] rounded-full flex justify-center items-center shadow-[0_0_30px_rgba(239,235,233,0.2)] active:scale-90 transition-transform">
                        <i data-lucide="play" id="timer-icon" class="w-8 h-8 fill-current"></i>
                    </button>
                    <button onclick="resetTimer()" class="w-20 h-20 glass-card rounded-full flex justify-center items-center active:scale-90 transition-transform">
                        <i data-lucide="rotate-ccw" class="w-6 h-6"></i>
                    </button>
                </div>
            </div>
        </div>

        <div id="focus-content-breath" class="hidden w-full max-w-md text-center">
            <div class="glass-card p-12 shadow-2xl border-white/10 flex flex-col items-center justify-center min-h-[300px]">
                <div class="breathing-circle w-32 h-32 rounded-full bg-[#EFEBE9] opacity-20 flex items-center justify-center mb-6"></div>
                <p class="text-xl font-serif italic text-[#D7CCC8]">Inhale... Exhale...</p>
            </div>
        </div>

    </main>

    <main id="notes-view" class="hidden min-h-screen pt-24 px-6 pb-32">
        <div class="h-full flex flex-col">
            <h2 class="text-3xl font-serif italic mb-6">Brain Dump</h2>
            <div class="glass-card flex-1 p-4 relative">
                <textarea id="brain-dump" class="w-full h-full bg-transparent border-none outline-none resize-none text-[#EFEBE9] font-sans text-lg leading-relaxed p-2 placeholder-opacity-50" placeholder="Type anything here... It saves automatically."></textarea>
                <div class="absolute bottom-4 right-4 text-[10px] uppercase text-[#A1887F] pointer-events-none">Saved</div>
            </div>
        </div>
    </main>

    <footer class="fixed bottom-0 left-0 right-0 glass-card rounded-b-none p-6 safe-pb z-40">
        <div class="flex justify-between items-end mb-2">
            <span class="text-[10px] font-bold uppercase tracking-widest text-[#A1887F]">Daily Goal</span>
            <span id="progress-percent" class="font-serif italic text-[#EFEBE9]">0%</span>
        </div>
        <div class="h-3 w-full bg-[#2D1B18] rounded-full overflow-hidden border border-white/10">
            <div id="progress-bar" class="h-full bg-gradient-to-r from-[#8D6E63] via-[#D7CCC8] to-[#EFEBE9] transition-all duration-1000" style="width: 0%"></div>
        </div>
    </footer>

    <script>
        // --- 1. CONFIG & DATA ---
        let items = JSON.parse(localStorage.getItem('nathan_items_v7')) || [
            { id: 1, name: "Morning Meds", time: "08:00", icon: "sun", done: false },
            { id: 2, name: "Lunch Break", time: "13:00", icon: "utensils", done: false },
            { id: 3, name: "Afternoon Rest", time: "16:00", icon: "armchair", done: false },
            { id: 4, name: "Night Routine", time: "20:00", icon: "moon", done: false }
        ];

        const days = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];
        let weeklySchedule = JSON.parse(localStorage.getItem('weekly_tracker_v2')) || getInitialWeeklyState();
        let waterCount = parseInt(localStorage.getItem('water_count')) || 0;
        let dailyMood = localStorage.getItem('daily_mood') || null;

        const itemToSlotMap = { 1: 'Morning', 2: 'Lunch', 4: 'Evening' };
        let myBarChart = null;
        let audioCtx, brownNoiseNode, gainNode, isZenPlaying = false;
        let nextTaskId = null;
        let timerTime = 300, timerInt, timerRun = false;

        // --- 2. INITIALIZATION ---
        function init() {
            startClock();
            renderList();
            updateNextUp();
            updateProgress();
            renderWeeklyGrid();
            initCharts();
            updateWaterUI();
            loadNotes();
            updateMoodUI();
            lucide.createIcons();
            
            // Check for new day reset for water
            const lastDate = localStorage.getItem('last_date');
            const today = new Date().toDateString();
            if(lastDate !== today) {
                waterCount = 0;
                localStorage.setItem('water_count', 0);
                dailyMood = null;
                localStorage.setItem('daily_mood', null);
                localStorage.setItem('last_date', today);
                updateWaterUI();
                updateMoodUI();
            }
        }

        // --- 3. NEW FEATURES LOGIC ---

        // Water
        function addWater() {
            if (waterCount < 8) {
                waterCount++;
                localStorage.setItem('water_count', waterCount);
                updateWaterUI();
                if(navigator.vibrate) navigator.vibrate(50);
            } else {
                if(confirm("Reset water counter?")) {
                    waterCount = 0;
                    localStorage.setItem('water_count', 0);
                    updateWaterUI();
                }
            }
        }

        function updateWaterUI() {
            document.getElementById('water-count').innerText = waterCount;
            const pct = (waterCount / 8) * 100;
            document.getElementById('water-fill').style.height = pct + '%';
        }

        // Notes
        const noteArea = document.getElementById('brain-dump');
        noteArea.addEventListener('input', (e) => {
            localStorage.setItem('nathan_notes', e.target.value);
        });
        function loadNotes() {
            noteArea.value = localStorage.getItem('nathan_notes') || '';
        }

        // Mood
        function setMood(level) {
            dailyMood = level;
            localStorage.setItem('daily_mood', level);
            updateMoodUI();
            if(navigator.vibrate) navigator.vibrate(50);
        }

        function updateMoodUI() {
            for(let i=1; i<=5; i++) {
                const el = document.getElementById(`mood-${i}`);
                if(dailyMood == i) {
                    el.classList.remove('opacity-50');
                    el.classList.add('scale-125');
                } else {
                    el.classList.add('opacity-50');
                    el.classList.remove('scale-125');
                }
            }
        }

        // Focus Mode Switcher
        function setFocusMode(mode) {
            const timerDiv = document.getElementById('focus-content-timer');
            const breathDiv = document.getElementById('focus-content-breath');
            const tabTimer = document.getElementById('tab-timer');
            const tabBreath = document.getElementById('tab-breath');

            if (mode === 'timer') {
                timerDiv.classList.remove('hidden');
                breathDiv.classList.add('hidden');
                tabTimer.classList.add('bg-[#EFEBE9]', 'text-[#3E2723]');
                tabTimer.classList.remove('text-[#A1887F]');
                tabBreath.classList.remove('bg-[#EFEBE9]', 'text-[#3E2723]');
                tabBreath.classList.add('text-[#A1887F]');
            } else {
                timerDiv.classList.add('hidden');
                breathDiv.classList.remove('hidden');
                tabBreath.classList.add('bg-[#EFEBE9]', 'text-[#3E2723]');
                tabBreath.classList.remove('text-[#A1887F]');
                tabTimer.classList.remove('bg-[#EFEBE9]', 'text-[#3E2723]');
                tabTimer.classList.add('text-[#A1887F]');
            }
        }

        // --- 4. CORE LOGIC (Routine & Weekly) ---
        function getInitialWeeklyState() {
            const state = {};
            days.forEach(day => state[day] = { 'Morning': false, 'Lunch': false, 'Evening': false });
            return state;
        }

        function syncToWeekly(itemId, isDone) {
            const todayName = new Date().toLocaleDateString('en-US', { weekday: 'long' });
            const slot = itemToSlotMap[itemId];
            if (slot && weeklySchedule[todayName]) {
                weeklySchedule[todayName][slot] = isDone;
                localStorage.setItem('weekly_tracker_v2', JSON.stringify(weeklySchedule));
                renderWeeklyGrid();
                updateCharts();
            }
        }

        function resetWeeklyData() {
            if(confirm("Reset entire week history?")) {
                weeklySchedule = getInitialWeeklyState();
                localStorage.setItem('weekly_tracker_v2', JSON.stringify(weeklySchedule));
                renderWeeklyGrid();
                updateCharts();
            }
        }

        function renderWeeklyGrid() {
            const grid = document.getElementById('weekly-grid');
            grid.innerHTML = '';
            const currentDayIndex = new Date().getDay() === 0 ? 6 : new Date().getDay() - 1;

            days.forEach((day, index) => {
                const dayData = weeklySchedule[day];
                const isToday = index === currentDayIndex;
                let dots = '';
                ['Morning', 'Lunch', 'Evening'].forEach(slot => {
                    let color = 'bg-[#4E342E]'; 
                    if (dayData[slot]) {
                        if (slot === 'Morning') color = 'bg-orange-400 shadow-[0_0_10px_orange]';
                        if (slot === 'Lunch') color = 'bg-green-400 shadow-[0_0_10px_lime]';
                        if (slot === 'Evening') color = 'bg-purple-400 shadow-[0_0_10px_violet]';
                    }
                    dots += `<div class="w-3 h-3 rounded-full ${color} transition-all duration-300"></div>`;
                });

                grid.innerHTML += `
                    <div class="glass-card p-4 flex justify-between items-center ${isToday ? 'border-[#D7CCC8] bg-[#3E2723]/60' : 'opacity-70'}">
                        <span class="font-serif ${isToday ? 'text-white font-bold' : 'text-[#A1887F]'}">${day}</span>
                        <div class="flex gap-2">${dots}</div>
                    </div>
                `;
            });
        }

        function initCharts() {
            const ctx = document.getElementById('barChart').getContext('2d');
            Chart.defaults.color = '#A1887F';
            Chart.defaults.borderColor = 'rgba(255,255,255,0.05)';
            myBarChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['M', 'T', 'W', 'T', 'F', 'S', 'S'],
                    datasets: [{
                        label: 'Tasks Done',
                        data: [0,0,0,0,0,0,0],
                        backgroundColor: '#D7CCC8',
                        borderRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: { y: { beginAtZero: true, max: 3, ticks: { stepSize: 1 } }, x: { grid: { display: false } } }
                }
            });
            updateCharts();
        }

        function updateCharts() {
            const data = days.map(day => {
                let count = 0;
                if(weeklySchedule[day].Morning) count++;
                if(weeklySchedule[day].Lunch) count++;
                if(weeklySchedule[day].Evening) count++;
                return count;
            });
            if(myBarChart) { myBarChart.data.datasets[0].data = data; myBarChart.update(); }
        }

        function toggleItem(id) {
            const idx = items.findIndex(m => m.id === id);
            items[idx].done = !items[idx].done;
            if (items[idx].done && navigator.vibrate) navigator.vibrate([50]);
            localStorage.setItem('nathan_items_v7', JSON.stringify(items));
            syncToWeekly(id, items[idx].done);
            renderList();
            updateNextUp();
            updateProgress();
        }

        function updateNextUp() {
            const nextItem = items.find(i => !i.done);
            const nameEl = document.getElementById('next-task-name');
            const timeEl = document.getElementById('next-task-time');
            const btn = document.getElementById('quick-check-btn');

            if (nextItem) {
                nextTaskId = nextItem.id;
                nameEl.innerText = nextItem.name;
                timeEl.innerText = nextItem.time;
                btn.classList.remove('hidden');
            } else {
                nextTaskId = null;
                nameEl.innerText = "All Done!";
                timeEl.innerText = "Rest well";
                btn.classList.add('hidden');
                fireConfetti();
            }
        }
        function quickCompleteNext() { if(nextTaskId) toggleItem(nextTaskId); }

        function renderList() {
            const list = document.getElementById('meds-list');
            list.innerHTML = items.map(item => `
                <div class="glass-card p-4 flex items-center justify-between transition-all duration-500 ${item.done ? 'opacity-40 grayscale scale-95' : ''}">
                    <div class="flex items-center gap-4">
                        <div class="glow-icon p-3 bg-[#3E2723] rounded-2xl text-[#D7CCC8]">
                            <i data-lucide="${item.icon}" class="w-6 h-6"></i>
                        </div>
                        <div>
                            <h3 class="font-serif italic text-lg">${item.name}</h3>
                            <p class="text-xs text-[#A1887F] font-bold tracking-widest">${item.time}</p>
                        </div>
                    </div>
                    <button onclick="toggleItem(${item.id})" class="w-12 h-12 rounded-full border-2 border-[#D7CCC8]/30 flex items-center justify-center transition-all active:scale-90 ${item.done ? 'bg-[#D7CCC8]' : ''}">
                        ${item.done ? '<i data-lucide="check" class="text-[#3E2723]"></i>' : ''}
                    </button>
                </div>
            `).join('');
            lucide.createIcons();
        }

        function updateProgress() {
            const doneCount = items.filter(m => m.done).length;
            const percent = Math.round((doneCount / items.length) * 100);
            document.getElementById('progress-bar').style.width = percent + '%';
            document.getElementById('progress-percent').innerText = percent + '%';
        }

        // --- 5. UTILITIES ---
        function startClock() {
            setInterval(() => {
                const now = new Date();
                document.getElementById('live-clock').innerText = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            }, 1000);
        }

        function toggleDrawer() {
            const drawer = document.getElementById('nav-drawer');
            const overlay = document.getElementById('drawer-overlay');
            if (drawer.classList.contains('drawer-closed')) {
                drawer.classList.remove('drawer-closed');
                drawer.classList.add('drawer-open');
                overlay.classList.remove('hidden');
            } else {
                drawer.classList.add('drawer-closed');
                drawer.classList.remove('drawer-open');
                overlay.classList.add('hidden');
            }
        }

        function switchView(view) {
            ['home-view', 'meds-view', 'timer-view', 'stats-view', 'notes-view'].forEach(id => document.getElementById(id).classList.add('hidden'));
            const backBtn = document.getElementById('global-back-btn');
            const header = document.getElementById('main-header');

            if (view === 'home') {
                document.getElementById('home-view').classList.remove('hidden');
                backBtn.classList.add('hidden');
                header.classList.remove('hidden');
                updateNextUp();
                updateWaterUI();
            } else {
                document.getElementById(`${view}-view`).classList.remove('hidden');
                backBtn.classList.remove('hidden');
                header.classList.add('hidden');
                if(view === 'stats') { renderWeeklyGrid(); setTimeout(() => updateCharts(), 100); }
            }
            window.scrollTo(0,0);
        }

        // --- 6. TIMER & CONFETTI ---
        function toggleTimer() {
            const icon = document.getElementById('timer-icon');
            if (timerRun) { clearInterval(timerInt); icon.setAttribute('data-lucide', 'play'); } 
            else {
                timerInt = setInterval(() => {
                    if (timerTime > 0) {
                        timerTime--;
                        const m = Math.floor(timerTime/60).toString().padStart(2,'0');
                        const s = (timerTime%60).toString().padStart(2,'0');
                        document.getElementById('timer-display').innerText = `${m}:${s}`;
                    } else { clearInterval(timerInt); resetTimer(); }
                }, 1000);
                icon.setAttribute('data-lucide', 'pause');
            }
            timerRun = !timerRun;
            lucide.createIcons();
        }
        function resetTimer() { clearInterval(timerInt); timerRun=false; timerTime=300; document.getElementById('timer-display').innerText = "05:00"; document.getElementById('timer-icon').setAttribute('data-lucide', 'play'); lucide.createIcons(); }

        function toggleZenMode() {
            if (!audioCtx) { audioCtx = new (window.AudioContext || window.webkitAudioContext)(); }
            if (isZenPlaying) { gainNode.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime+1); setTimeout(() => brownNoiseNode.disconnect(), 1000); isZenPlaying = false; }
            else {
                const bSize = 4096;
                const wn = audioCtx.createScriptProcessor(bSize, 1, 1);
                wn.onaudioprocess = e => {
                    const out = e.outputBuffer.getChannelData(0);
                    for (let i=0; i<bSize; i++) {
                        const w = Math.random()*2-1;
                        out[i] = (lastOut + (0.02*w))/1.02;
                        lastOut = out[i];
                        out[i] *= 3.5;
                    }
                };
                let lastOut = 0;
                brownNoiseNode = wn;
                gainNode = audioCtx.createGain();
                gainNode.gain.setValueAtTime(0, audioCtx.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.15, audioCtx.currentTime+2);
                brownNoiseNode.connect(gainNode);
                gainNode.connect(audioCtx.destination);
                isZenPlaying = true;
            }
        }

        function fireConfetti() {
            const c = document.getElementById('confetti-canvas'); const x = c.getContext('2d');
            c.width = window.innerWidth; c.height = window.innerHeight;
            const p = Array(100).fill().map(() => ({x:Math.random()*c.width, y:Math.random()*c.height-c.height, r:Math.random()*360, s:Math.random()*5+2, c: ['#D7CCC8','#8D6E63'][Math.floor(Math.random()*2)]}));
            function d() {
                x.clearRect(0,0,c.width,c.height);
                p.forEach(k => { x.save(); x.translate(k.x,k.y); x.rotate(k.r*Math.PI/180); x.fillStyle=k.c; x.fillRect(-k.s/2,-k.s/2,k.s,k.s); x.restore(); k.y+=k.s; k.r+=2; });
                if(p.some(k=>k.y<c.height)) requestAnimationFrame(d);
            } d();
        }

        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
